<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oklahoma Investigation Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }

    .panel{
      position: absolute;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      width: 440px;
      max-width: calc(100vw - 20px);
    }

    /* Collapsible container */
    #menuWrap{
      top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #menuHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    #menuTitle{
      font-weight: 700;
      font-size: 14px;
    }

    #menuToggle{
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    /* Menu content collapses */
    .menuBody{ display: block; }
    .collapsed .menuBody{ display: none; }

    .row{
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    input, select, button, textarea{
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      font-family: inherit;
    }
    textarea { width: 100%; min-height: 60px; resize: vertical; }
    #search{ flex: 1; min-width: 200px; }
    label { font-size: 13px; }

    .hint{ font-size: 12px; color: #555; margin-top: 4px; line-height: 1.25; }
    .small{ width: 130px; }
    .grow{ flex: 1; min-width: 160px; }
    .btnRow{ display: flex; gap: 8px; flex-wrap: wrap; }
    .danger{ border-color: #d33 !important; color: #d33 !important; }

    .editMode{ font-size: 12px; color: #0a5; margin-top: 4px; display: none; }

    /* Little color dots for county toggles */
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      border: 1px solid rgba(0,0,0,.25);
    }

    @media (max-width: 600px){
      .panel{ width: calc(100vw - 20px); }
    }
  </style>
</head>

<body>
  <!-- Collapsible Menu -->
  <div id="menuWrap" class="panel collapsed">
    <div id="menuHeader">
      <div id="menuTitle">Investigation Menu</div>
      <button id="menuToggle" type="button">Open</button>
    </div>

    <div class="menuBody">
      <!-- Filters -->
      <div id="controls">
        <div class="row">
          <input id="search" type="text" placeholder="Search location name..." />
          <button id="clearBtn" type="button">Clear</button>
        </div>

        <div class="row">
          <label for="teamFilter">Team:</label>
          <select id="teamFilter">
            <option value="ALL">All</option>
            <option value="Okmulgee Team">Okmulgee Team</option>
            <option value="Tulsa Team">Tulsa Team</option>
            <option value="Unassigned">Unassigned</option>
          </select>

          <label for="statusFilter">Status:</label>
          <select id="statusFilter">
            <option value="ALL">All</option>
            <option value="Active">Active</option>
            <option value="Closed">Closed</option>
            <option value="Unknown">Unknown</option>
          </select>
        </div>

        <div class="row">
          <label for="permissionFilter">Permission:</label>
          <select id="permissionFilter">
            <option value="ALL">All</option>
            <option value="Required">Required</option>
            <option value="Not Required">Not Required</option>
            <option value="Unknown">Unknown</option>
          </select>

          <label for="entityFilter">Entity:</label>
          <select id="entityFilter">
            <option value="ALL">All</option>
            <option value="Ghost">Ghost</option>
            <option value="Demon">Demon</option>
            <option value="Unknown">Unknown</option>
          </select>
        </div>

        <div class="row">
          <label for="typeFilter">Type:</label>
          <select id="typeFilter">
            <option value="ALL">All</option>
            <option value="Cemetery">Cemetery</option>
            <option value="Structure (In Use)">Structure (In Use)</option>
            <option value="Structure (Abandoned)">Structure (Abandoned)</option>
            <option value="Park">Park</option>
            <option value="Lake">Lake</option>
            <option value="Road/Bridge">Road/Bridge</option>
            <option value="Other">Other</option>
            <option value="Unknown">Unknown</option>
          </select>
        </div>
      </div>

      <!-- County toggles (no "County highlights..." header text) -->
      <div style="margin-top:10px;">
        <div class="row" style="margin-bottom:4px;">
          <span class="dot" style="background:#e31a1c;"></span>
          <strong style="font-size:13px;">Red</strong>
        </div>
        <div class="row" id="countyHighlightControlsRed"></div>

        <div class="row" style="margin:8px 0 4px;">
          <span class="dot" style="background:#33a02c;"></span>
          <strong style="font-size:13px;">Green</strong>
        </div>
        <div class="row" id="countyHighlightControlsGreen"></div>
      </div>

      <!-- New Location Form -->
      <div id="newLocationPanel" style="margin-top:10px;">
        <div class="row">
          <strong>New Location</strong>
          <span class="hint">Tip: click “Pick from map”, then click the map to fill lat/lng.</span>
        </div>

        <div id="editModeBanner" class="editMode">Editing an existing pin. Submit will UPDATE it.</div>

        <form id="newLocationForm">
          <div class="row">
            <input id="nl_name" class="grow" type="text" placeholder="Location name (required)" required />
            <select id="nl_team" class="small">
              <option value="Unassigned">Unassigned</option>
              <option value="Okmulgee Team">Okmulgee Team</option>
              <option value="Tulsa Team">Tulsa Team</option>
            </select>
          </div>

          <div class="row">
            <select id="nl_type" class="small">
              <option value="Unknown">Type: Unknown</option>
              <option value="Cemetery">Type: Cemetery</option>
              <option value="Structure (In Use)">Type: Structure (In Use)</option>
              <option value="Structure (Abandoned)">Type: Structure (Abandoned)</option>
              <option value="Park">Type: Park</option>
              <option value="Lake">Type: Lake</option>
              <option value="Road/Bridge">Type: Road/Bridge</option>
              <option value="Other">Type: Other</option>
            </select>

            <select id="nl_status" class="small">
              <option value="Active">Active</option>
              <option value="Closed">Closed</option>
              <option value="Unknown">Unknown</option>
            </select>

            <select id="nl_permission" class="small">
              <option value="Unknown">Permission: Unknown</option>
              <option value="Required">Permission: Required</option>
              <option value="Not Required">Permission: Not Required</option>
            </select>

            <select id="nl_entity" class="small">
              <option value="Unknown">Entity: Unknown</option>
              <option value="Ghost">Entity: Ghost</option>
              <option value="Demon">Entity: Demon</option>
            </select>
          </div>

          <div class="row">
            <input id="nl_lat" class="small" type="number" step="any" placeholder="Lat" required />
            <input id="nl_lng" class="small" type="number" step="any" placeholder="Lng" required />
            <button id="pickBtn" type="button">Pick from map</button>
          </div>

          <div class="row">
            <textarea id="nl_details" placeholder="Details / notes (optional)"></textarea>
          </div>

          <div class="btnRow">
            <button id="submitBtn" type="submit">Add Location</button>
            <button id="cancelEditBtn" type="button" style="display:none;">Cancel Edit</button>
          </div>

          <div id="pickHint" class="hint" style="display:none;">
            Click the map to set coordinates. Press Esc to cancel.
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      doc,
      updateDoc,
      deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ----- FIREBASE CONFIG -----
    const firebaseConfig = {
      apiKey: "AIzaSyAfAk1hl11uDpC3JB7m0JvwnPf8rVXxJTg",
      authDomain: "oklahoma-investigation-map.firebaseapp.com",
      projectId: "oklahoma-investigation-map",
      storageBucket: "oklahoma-investigation-map.firebasestorage.app",
      messagingSenderId: "809288424180",
      appId: "1:809288424180:web:6b6989762ea7db99151ca1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const LOCATIONS = "locations";

    function setStatus(msg){
      console.log("[Firestore]", msg);
    }

    // ----- DOM -----
    const menuWrap = document.getElementById("menuWrap");
    const menuToggle = document.getElementById("menuToggle");

    const searchEl = document.getElementById("search");
    const clearBtn = document.getElementById("clearBtn");
    const teamFilterEl = document.getElementById("teamFilter");
    const statusFilterEl = document.getElementById("statusFilter");
    const permissionFilterEl = document.getElementById("permissionFilter");
    const entityFilterEl = document.getElementById("entityFilter");
    const typeFilterEl = document.getElementById("typeFilter");

    const countyControlsRed = document.getElementById("countyHighlightControlsRed");
    const countyControlsGreen = document.getElementById("countyHighlightControlsGreen");

    const editModeBanner = document.getElementById("editModeBanner");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const submitBtn = document.getElementById("submitBtn");

    const form = document.getElementById("newLocationForm");
    const nl_name = document.getElementById("nl_name");
    const nl_team = document.getElementById("nl_team");
    const nl_type = document.getElementById("nl_type");
    const nl_status = document.getElementById("nl_status");
    const nl_permission = document.getElementById("nl_permission");
    const nl_entity = document.getElementById("nl_entity");
    const nl_lat = document.getElementById("nl_lat");
    const nl_lng = document.getElementById("nl_lng");
    const nl_details = document.getElementById("nl_details");
    const pickBtn = document.getElementById("pickBtn");
    const pickHint = document.getElementById("pickHint");

    // Collapsible menu
    function setMenuCollapsed(collapsed){
      menuWrap.classList.toggle("collapsed", collapsed);
      menuToggle.textContent = collapsed ? "Open" : "Close";
    }
    menuToggle.addEventListener("click", () => {
      const collapsed = menuWrap.classList.contains("collapsed");
      setMenuCollapsed(!collapsed);
    });
    setMenuCollapsed(window.matchMedia("(max-width: 600px)").matches);

    // ----- MAP -----
    const map = L.map('map').setView([35.4676, -97.5164], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);
    let markers = [];
    let editingId = null;

    function setEditMode(idOrNull) {
      editingId = idOrNull;
      const on = !!editingId;
      editModeBanner.style.display = on ? "block" : "none";
      cancelEditBtn.style.display = on ? "inline-block" : "none";
      submitBtn.textContent = on ? "Update Location" : "Add Location";
    }

    function makeMarker(loc) {
      const actions = `
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="editPinBtn" data-id="${loc.id}">Edit</button>
          <button type="button" class="deletePinBtn danger" data-id="${loc.id}">Delete</button>
        </div>`;

      return L.marker([loc.lat, loc.lng]).bindPopup(
        `<b>${loc.name}</b><br>
         Type: ${loc.type}<br>
         Team: ${loc.team}<br>
         Status: ${loc.status}<br>
         Permission: ${loc.permission}<br>
         Entity: ${loc.entity}<br><br>
         ${loc.details ? loc.details : ""}
         ${actions}`
      );
    }

    function applyFilters() {
      const teamValue = teamFilterEl.value;
      const statusValue = statusFilterEl.value;
      const permissionValue = permissionFilterEl.value;
      const entityValue = entityFilterEl.value;
      const typeValue = typeFilterEl.value;
      const searchValue = searchEl.value.trim().toLowerCase();

      markerLayer.clearLayers();

      markers.forEach(({ loc, marker }) => {
        const teamOk = (teamValue === "ALL") || (loc.team === teamValue);
        const statusOk = (statusValue === "ALL") || (loc.status === statusValue);
        const permissionOk = (permissionValue === "ALL") || (loc.permission === permissionValue);
        const entityOk = (entityValue === "ALL") || (loc.entity === entityValue);
        const typeOk = (typeValue === "ALL") || (loc.type === typeValue);
        const searchOk = (searchValue === "") || (String(loc.name || "").toLowerCase().includes(searchValue));

        if (teamOk && statusOk && permissionOk && entityOk && typeOk && searchOk) {
          marker.addTo(markerLayer);
        }
      });
    }

    // Popup buttons
    map.on("popupopen", (e) => {
      const popupEl = e.popup.getElement();
      if (!popupEl) return;

      const editBtn = popupEl.querySelector(".editPinBtn");
      const deleteBtn = popupEl.querySelector(".deletePinBtn");

      if (editBtn) {
        editBtn.addEventListener("click", () => {
          const id = editBtn.dataset.id;
          const loc = markers.find(m => m.loc.id === id)?.loc;
          if (!loc) return alert("Could not find that pin.");

          nl_name.value = loc.name || "";
          nl_team.value = loc.team || "Unassigned";
          nl_type.value = `Type: ${loc.type || "Unknown"}`.replace("Type: Type: ", "Type: ");
          nl_status.value = loc.status || "Unknown";
          nl_permission.value = loc.permission || "Unknown";
          nl_entity.value = loc.entity || "Unknown";
          nl_lat.value = Number(loc.lat).toFixed(6);
          nl_lng.value = Number(loc.lng).toFixed(6);
          nl_details.value = loc.details || "";

          setEditMode(id);
          alert("Editing mode enabled. Update the form and click Update Location.");
          if (window.matchMedia("(max-width: 600px)").matches) setMenuCollapsed(false);
        });
      }

      if (deleteBtn) {
        deleteBtn.addEventListener("click", async () => {
          const id = deleteBtn.dataset.id;
          if (!confirm("Delete this pin? This cannot be undone.")) return;

          try {
            await deleteDoc(doc(db, LOCATIONS, id));
            if (editingId === id) setEditMode(null);
          } catch (err) {
            console.error(err);
            alert("Delete failed: " + (err?.message || err));
          }
        });
      }
    });

    // Filter events
    teamFilterEl.addEventListener("change", () => {
      applyFilters();
      syncCountyHighlightsToTeamFilter(); // <- updates overlays
    });
    statusFilterEl.addEventListener("change", applyFilters);
    permissionFilterEl.addEventListener("change", applyFilters);
    entityFilterEl.addEventListener("change", applyFilters);
    typeFilterEl.addEventListener("change", applyFilters);
    searchEl.addEventListener("input", applyFilters);

    clearBtn.addEventListener("click", () => {
      teamFilterEl.value = "ALL";
      statusFilterEl.value = "ALL";
      permissionFilterEl.value = "ALL";
      entityFilterEl.value = "ALL";
      typeFilterEl.value = "ALL";
      searchEl.value = "";
      applyFilters();
      syncCountyHighlightsToTeamFilter();
    });

    // Pick coords mode
    let picking = false;
    function setPicking(on) {
      picking = on;
      pickHint.style.display = on ? "block" : "none";
      pickBtn.textContent = on ? "Picking…" : "Pick from map";
      pickBtn.disabled = on;
      map.getContainer().style.cursor = on ? "crosshair" : "";
    }
    pickBtn.addEventListener("click", () => setPicking(true));
    map.on("click", (e) => {
      if (!picking) return;
      nl_lat.value = e.latlng.lat.toFixed(6);
      nl_lng.value = e.latlng.lng.toFixed(6);
      setPicking(false);
      if (window.matchMedia("(max-width: 600px)").matches) setMenuCollapsed(false);
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && picking) setPicking(false);
    });

    cancelEditBtn.addEventListener("click", () => {
      setEditMode(null);
      form.reset();
    });

    // Submit -> Firestore add/update
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = nl_name.value.trim();
      const team = nl_team.value;

      const type = (nl_type.value || "Type: Unknown").replace("Type: ", "");
      const status = nl_status.value;
      const permission = (nl_permission.value || "Unknown").replace("Permission: ", "");
      const entity = (nl_entity.value || "Unknown").replace("Entity: ", "");

      const lat = Number(nl_lat.value);
      const lng = Number(nl_lng.value);
      const details = nl_details.value.trim();

      if (!name) return alert("Location name is required.");
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return alert("Valid latitude and longitude are required.");

      const payload = {
        name, team, type, status, permission, entity, lat, lng, details,
        updatedAt: serverTimestamp()
      };

      try {
        if (editingId) {
          await updateDoc(doc(db, LOCATIONS, editingId), payload);
          alert("Location updated!");
          setEditMode(null);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, LOCATIONS), payload);
          alert("Location added!");
        }
        form.reset();
        if (window.matchMedia("(max-width: 600px)").matches) setMenuCollapsed(true);
      } catch (err) {
        console.error(err);
        alert("Save failed: " + (err?.message || err));
      }
    });

    // Real-time listener
    setStatus("Connecting to Firestore…");
    onSnapshot(
      collection(db, LOCATIONS),
      (snapshot) => {
        setStatus(`Connected.\nCollection: ${LOCATIONS}\nDocs loaded: ${snapshot.size}`);

        markers = [];
        snapshot.forEach((docSnap) => {
          const d = docSnap.data();
          const loc = {
            id: docSnap.id,
            name: d.name || "(Unnamed)",
            type: d.type || "Unknown",
            team: d.team || "Unassigned",
            status: d.status || "Unknown",
            permission: d.permission || "Unknown",
            entity: d.entity || "Unknown",
            lat: Number(d.lat),
            lng: Number(d.lng),
            details: d.details || ""
          };
          if (Number.isFinite(loc.lat) && Number.isFinite(loc.lng)) {
            markers.push({ loc, marker: makeMarker(loc) });
          }
        });

        applyFilters();
      },
      (err) => {
        console.error(err);
        setStatus("Listener error:\n" + (err?.message || err));
      }
    );

    // ----- COUNTY HIGHLIGHTS (OVERLAY LAYERS, FIXED) -----
    const RED_COUNTIES = ["Tulsa","Wagoner","Rogers","Washington","Osage"];
    const GREEN_COUNTIES = ["Creek","Okmulgee","Muskogee","McIntosh","Okfuskee"];

    const RED_BASE = "#e31a1c";
    const GREEN_BASE = "#33a02c";

    // Normalize county names so GeoJSON matches regardless of case / "County" suffix
    function normCountyName(s){
      return String(s || "")
        .replace(/\s+county$/i, "")
        .trim()
        .toLowerCase();
    }

    function hexToRgb(hex){
      const h = (hex || "").replace("#", "").trim();
      if (h.length !== 6) return null;
      const n = parseInt(h, 16);
      return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
    }
    function rgbToHex({r,g,b}){
      const toHex = (v) => v.toString(16).padStart(2, "0");
      return "#" + toHex(r) + toHex(g) + toHex(b);
    }
    function brighten(hex, amt = 0.45){
      const rgb = hexToRgb(hex);
      if (!rgb) return hex;
      const mix = (c) => Math.round(c + (255 - c) * amt);
      return rgbToHex({ r: mix(rgb.r), g: mix(rgb.g), b: mix(rgb.b) });
    }
    function darken(hex, amt = 0.30){
      const rgb = hexToRgb(hex);
      if (!rgb) return hex;
      const mix = (c) => Math.round(c * (1 - amt));
      return rgbToHex({ r: mix(rgb.r), g: mix(rgb.g), b: mix(rgb.b) });
    }

    // Full sets (normalized)
    const RED_ALL = new Set(RED_COUNTIES.map(normCountyName));
    const GREEN_ALL = new Set(GREEN_COUNTIES.map(normCountyName));

    // Enabled sets (start ON by default)
    const enabledRed = new Set(RED_ALL);
    const enabledGreen = new Set(GREEN_ALL);

    // Track checkboxes by normalized county name
    const checkboxByNorm = {};

    // Base counties style (neutral outline)
    function baseCountyStyle(){
      return { color: "#000", weight: 2, fillOpacity: 0.03, fillColor: "#ffffff" };
    }

    // Highlight overlay style
    function highlightStyle(baseColor){
      return {
        color: darken(baseColor, 0.30),
        weight: 4,
        fillOpacity: 0.65,
        fillColor: brighten(baseColor, 0.45)
      };
    }

    // Create a dedicated pane so highlights are guaranteed above the base polygons
    const highlightPane = map.createPane("countyHighlightPane");
    highlightPane.style.zIndex = 450;

    // GeoJSON data + layers
    let countiesData = null;
    let baseCountiesLayer = null;
    let redHighlightLayer = null;
    let greenHighlightLayer = null;

    function ensureHighlightLayers(){
      if (!redHighlightLayer){
        redHighlightLayer = L.geoJSON(null, {
          pane: "countyHighlightPane",
          interactive: false,
          filter: (feature) => {
            const name = feature?.properties?.NAME ?? feature?.properties?.name ?? "";
            return enabledRed.has(normCountyName(name));
          },
          style: () => highlightStyle(RED_BASE)
        }).addTo(map);
      }
      if (!greenHighlightLayer){
        greenHighlightLayer = L.geoJSON(null, {
          pane: "countyHighlightPane",
          interactive: false,
          filter: (feature) => {
            const name = feature?.properties?.NAME ?? feature?.properties?.name ?? "";
            return enabledGreen.has(normCountyName(name));
          },
          style: () => highlightStyle(GREEN_BASE)
        }).addTo(map);
      }
    }

    function rebuildHighlightLayers(){
      if (!countiesData) return;
      ensureHighlightLayers();

      redHighlightLayer.clearLayers();
      greenHighlightLayer.clearLayers();

      redHighlightLayer.addData(countiesData);
      greenHighlightLayer.addData(countiesData);

      redHighlightLayer.bringToFront();
      greenHighlightLayer.bringToFront();
    }

    function addCountyCheckbox(containerEl, countyDisplayName, baseColor, enabledSet){
      const n = normCountyName(countyDisplayName);
      const id = `hl_${countyDisplayName.replace(/\s+/g, "_")}`;

      const wrap = document.createElement("label");
      wrap.style.display = "inline-flex";
      wrap.style.alignItems = "center";
      wrap.style.gap = "6px";
      wrap.style.marginRight = "10px";
      wrap.style.cursor = "pointer";
      wrap.style.userSelect = "none";
      wrap.style.fontSize = "13px";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = id;
      cb.checked = enabledSet.has(n);
      checkboxByNorm[n] = cb;

      cb.addEventListener("change", () => {
        if (cb.checked) enabledSet.add(n);
        else enabledSet.delete(n);
        rebuildHighlightLayers();
      });

      const dot = document.createElement("span");
      dot.className = "dot";
      dot.style.background = baseColor;

      const text = document.createElement("span");
      text.textContent = countyDisplayName;

      wrap.appendChild(cb);
      wrap.appendChild(dot);
      wrap.appendChild(text);
      containerEl.appendChild(wrap);
    }

    function buildCountyToggleUI(){
      if (countyControlsRed) countyControlsRed.innerHTML = "";
      if (countyControlsGreen) countyControlsGreen.innerHTML = "";

      RED_COUNTIES.forEach(c => addCountyCheckbox(countyControlsRed, c, RED_BASE, enabledRed));
      GREEN_COUNTIES.forEach(c => addCountyCheckbox(countyControlsGreen, c, GREEN_BASE, enabledGreen));
    }

    // Team dropdown rule:
    // ALL -> both, Tulsa Team -> red only, Okmulgee Team -> green only, Unassigned -> none
    function syncCountyHighlightsToTeamFilter(){
      const v = teamFilterEl.value;

      const setTo = (targetSet, sourceSet) => {
        targetSet.clear();
        for (const x of sourceSet) targetSet.add(x);
      };

      if (v === "Tulsa Team") {
        setTo(enabledRed, RED_ALL);
        enabledGreen.clear();
      } else if (v === "Okmulgee Team") {
        enabledRed.clear();
        setTo(enabledGreen, GREEN_ALL);
      } else if (v === "ALL") {
        setTo(enabledRed, RED_ALL);
        setTo(enabledGreen, GREEN_ALL);
      } else {
        enabledRed.clear();
        enabledGreen.clear();
      }

      // Update checkboxes to match
      for (const n of RED_ALL){
        if (checkboxByNorm[n]) checkboxByNorm[n].checked = enabledRed.has(n);
      }
      for (const n of GREEN_ALL){
        if (checkboxByNorm[n]) checkboxByNorm[n].checked = enabledGreen.has(n);
      }

      rebuildHighlightLayers();
    }

    // Build checkbox UI (checked by default)
    buildCountyToggleUI();

    // Load counties + draw base outlines + overlays
    fetch("./data/counties_ok.geojson")
      .then(res => {
        if (!res.ok) throw new Error("Counties file not found: ./data/counties_ok.geojson");
        return res.json();
      })
      .then(counties => {
        countiesData = counties;

        // Base counties layer (neutral outlines)
        baseCountiesLayer = L.geoJSON(countiesData, {
          style: () => baseCountyStyle(),
          onEachFeature: (feature, layer) => {
            const rawName = feature?.properties?.NAME ?? feature?.properties?.name ?? "Unknown";
            const prettyName = String(rawName).replace(/\s+County$/i, "");
            layer.bindTooltip(`${prettyName} County`);
            layer.bindPopup(`<b>${prettyName} County</b>`);
          }
        }).addTo(map);

        ensureHighlightLayers();

        // Default team = ALL, so both red+green ON
        syncCountyHighlightsToTeamFilter();
      })
      .catch(err => console.error("GeoJSON load error:", err));
  </script>
</body>
</html>
