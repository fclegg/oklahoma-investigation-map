<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oklahoma Investigation Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }

    .panel{
      position: absolute;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
      font-family: system-ui, Arial, sans-serif;
      width: 440px;
      max-width: calc(100vw - 20px);
    }
    #controls{ top: 10px; }
    #newLocationPanel{ top: 145px; }

    .row{
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    input, select, button, textarea{
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    textarea { width: 100%; min-height: 60px; }
    #search{ flex: 1; }
    .danger{ color: #c00; border-color: #c00; }
    .editMode{ font-size: 12px; color: #0a5; display: none; }
  </style>
</head>

<body>

<div id="controls" class="panel">
  <div class="row">
    <input id="search" placeholder="Search location..." />
    <button id="clearBtn">Clear</button>
  </div>
</div>

<div id="newLocationPanel" class="panel">
  <strong>New / Edit Location</strong>
  <div id="editBanner" class="editMode">Editing existing pin</div>

  <form id="form">
    <input id="name" placeholder="Location name" required />
    <input id="lat" placeholder="Lat" required />
    <input id="lng" placeholder="Lng" required />

    <select id="team">
      <option>Unassigned</option>
      <option>Okmulgee Team</option>
      <option>Tulsa Team</option>
    </select>

    <select id="entity">
      <option>Unknown</option>
      <option>Ghost</option>
      <option>Demon</option>
    </select>

    <textarea id="details" placeholder="Notes"></textarea>

    <button type="submit" id="submitBtn">Add Location</button>
    <button type="button" id="cancelEdit" style="display:none">Cancel</button>
  </form>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, onSnapshot,
    doc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // ðŸ”¥ YOUR FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyAfAk1hl11uDpC3JB7m0JvwnPf8rVXxJTg",
    authDomain: "oklahoma-investigation-map.firebaseapp.com",
    projectId: "oklahoma-investigation-map",
    storageBucket: "oklahoma-investigation-map.firebasestorage.app",
    messagingSenderId: "809288424180",
    appId: "1:809288424180:web:6b6989762ea7db99151ca1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------------- MAP ----------------
  const map = L.map("map").setView([35.5, -97.5], 7);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const layer = L.layerGroup().addTo(map);
  let editingId = null;

  function renderPin(loc, id){
    const m = L.marker([loc.lat, loc.lng]).addTo(layer);
    m.bindPopup(`
      <b>${loc.name}</b><br>
      Team: ${loc.team}<br>
      Entity: ${loc.entity}<br><br>
      ${loc.details || ""}<br><br>
      <button data-edit="${id}">Edit</button>
      <button data-del="${id}" class="danger">Delete</button>
    `);

    m.on("popupopen", e => {
      const el = e.popup.getElement();
      el.querySelector("[data-edit]").onclick = () => editPin(id, loc);
      el.querySelector("[data-del]").onclick = async () => {
        if(confirm("Delete this pin?")){
          await deleteDoc(doc(db,"locations",id));
        }
      };
    });
  }

  function editPin(id, loc){
    editingId = id;
    editBanner.style.display = "block";
    cancelEdit.style.display = "inline";
    submitBtn.textContent = "Update Location";

    name.value = loc.name;
    lat.value = loc.lat;
    lng.value = loc.lng;
    team.value = loc.team;
    entity.value = loc.entity;
    details.value = loc.details || "";
  }

  // LIVE DATABASE LISTENER
  onSnapshot(collection(db,"locations"), snap => {
    layer.clearLayers();
    snap.forEach(docSnap => {
      renderPin(docSnap.data(), docSnap.id);
    });
  });

  // FORM SUBMIT
  form.onsubmit = async e => {
    e.preventDefault();

    const data = {
      name: name.value,
      lat: Number(lat.value),
      lng: Number(lng.value),
      team: team.value,
      entity: entity.value,
      details: details.value
    };

    if(editingId){
      await updateDoc(doc(db,"locations",editingId), data);
    } else {
      await addDoc(collection(db,"locations"), data);
    }

    form.reset();
    editingId = null;
    editBanner.style.display = "none";
    cancelEdit.style.display = "none";
    submitBtn.textContent = "Add Location";
  };

  cancelEdit.onclick = () => {
    editingId = null;
    form.reset();
    editBanner.style.display = "none";
    cancelEdit.style.display = "none";
    submitBtn.textContent = "Add Location";
  };

  map.on("click", e => {
    lat.value = e.latlng.lat.toFixed(6);
    lng.value = e.latlng.lng.toFixed(6);
  });
</script>

</body>
</html>
